#!/usr/bin/env bash

set -e

ecrname=$(aws cloudformation describe-stacks --stack-name ops-challenge-g-ecr --query "Stacks[0].Outputs[?OutputKey=='RepositoryName'].OutputValue" --output text)

# mycertarn=$(aws ssm get-parameter --name "/cfg/georgia-app/cert-arn" --output text --query 'Parameter.Value' --no-cli-pager)

name='vpc-and-networking-stack-ops-challenge-g'

commit=$(git describe --tags --always)

aws cloudformation deploy \
      --template-file ./cfn/infra-stack.yaml \
      --parameter-overrides \
            RepositoryName=$name \
            ECRRepositoryName=$ecrname \
            Commit=$commit \
      --stack-name $name \
      --region ap-southeast-2 \
      --no-fail-on-empty-changeset