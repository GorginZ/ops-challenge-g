#!/usr/bin/env bash

set -e

ecrname=$(aws cloudformation describe-stacks --stack-name ops-challenge-g-ecr --query "Stacks[0].Outputs[?OutputKey=='RepositoryName'].OutputValue" --output text)
commit=$(git describe --tags --always)

secret=$(aws ssm get-parameter --name "/georgialeng.com/ops-challenge/secret" --with-decryption --output text --query 'Parameter.Value' --no-cli-pager)

docker build -t "$ecrname:$commit" . --build-arg SECRET=$secret 
docker push "$ecrname:$commit"

docker build -t "$ecrname:latest" . --build-arg SECRET=$secret
docker push "$ecrname:latest"